---
subject: 专业课843
chapter: 计算机网络
mastery: 0
next-review: 2026-03-05
status: 未开始
created: 2026-02-27
---

# 03 — 网络层

> 导航：[[02-科目/专业课/知识点/技术/计算机网络/00-网络MOC|网络MOC]] | 上：[[02-科目/专业课/知识点/技术/计算机网络/02-数据链路层|02-数据链路层]] | 下：[[02-科目/专业课/知识点/技术/计算机网络/04-传输层|04-传输层]]

---

## 一、IPv4 地址（★★★）

### 分类编址

| 类别 | 首位 | 范围 | 默认子网掩码 | 用途 |
|------|------|------|-------------|------|
| A 类 | 0 | 1.0.0.0 ~ 126.255.255.255 | /8 (255.0.0.0) | 超大型网络 |
| B 类 | 10 | 128.0.0.0 ~ 191.255.255.255 | /16 (255.255.0.0) | 大型网络 |
| C 类 | 110 | 192.0.0.0 ~ 223.255.255.255 | /24 (255.255.255.0) | 小型网络 |
| D 类 | 1110 | 224.0.0.0 ~ 239.255.255.255 | — | 组播地址 |
| E 类 | 1111 | 240.0.0.0 ~ 255.255.255.255 | — | 保留/实验 |

> **记忆**：127.x.x.x 是回环地址（loopback），不属于A类可用范围

### 子网划分与 CIDR

**借位原理**：从主机位借若干位作子网位，子网数增加但每个子网主机数减少

**CIDR（无类域间路由）**：用斜线加前缀长度表示，如 `192.168.1.0/26`

**典型计算例题**：

```
题目：192.168.1.0/26，求子网数、每个子网主机数、广播地址

解：
- /26 = 前26位为网络位，主机位 = 32-26 = 6位
- 子网数：C类默认/24，借了 26-24=2 位，子网数 = 2² = 4
- 每子网主机数：2⁶ - 2 = 62（减去网络地址和广播地址）
- 4个子网：
  192.168.1.0/26   （主机 .1~.62，广播 .63）
  192.168.1.64/26  （主机 .65~.126，广播 .127）
  192.168.1.128/26 （主机 .129~.190，广播 .191）
  192.168.1.192/26 （主机 .193~.254，广播 .255）
```

**子网掩码计算**：/26 → 前26位全1 = 11111111.11111111.11111111.11000000 = 255.255.255.192

### 特殊 IP 地址

| 地址 | 含义 |
|------|------|
| `127.0.0.1` | 本地回环地址（loopback），不出网卡 |
| `255.255.255.255` | 受限广播地址，不被路由器转发 |
| `0.0.0.0` | 本主机（用于DHCP请求，路由表默认路由） |
| `主机位全0` | 网络地址（标识网段，不可分配） |
| `主机位全1` | 定向广播地址（针对特定子网） |
| `10.x.x.x / 172.16~31.x.x / 192.168.x.x` | 私网地址，不在公网路由 |

---

## 二、IP 数据报格式

### 首部字段（20字节固定部分）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
├─────┬─────────┬──────────────────────────────────────────────────┤
│版本(4)│首部长度(4)│   区分服务(8)       │        总长度(16)         │
├─────────────────────────────┬─┬─┬──────────────────────────────┤
│           标识(16)          │标志(3)│       片偏移(13)            │
├─────────────────────────────┴─┴─┴──────────────────────────────┤
│     TTL(8)      │   协议(8)      │       首部校验和(16)          │
├──────────────────────────────────────────────────────────────────┤
│                         源IP地址(32)                             │
├──────────────────────────────────────────────────────────────────┤
│                        目的IP地址(32)                            │
└──────────────────────────────────────────────────────────────────┘
```

**关键字段说明**：

| 字段 | 位数 | 说明 |
|------|------|------|
| 版本 | 4 | IPv4=4，IPv6=6 |
| 首部长度 | 4 | 以4字节为单位，最小5（=20字节），最大15（=60字节） |
| 总长度 | 16 | 首部+数据的字节数，最大65535字节 |
| 标识 | 16 | 同一数据报的所有分片共享同一标识 |
| 标志 | 3 | DF（不分片）、MF（还有后续分片） |
| 片偏移 | 13 | 本片数据相对原始数据报的偏移，**以8字节为单位** |
| TTL | 8 | 每经过一个路由器减1，为0则丢弃（防止环路死循环） |
| 协议 | 8 | 上层协议：TCP=6，UDP=17，ICMP=1，OSPF=89 |

### IP 分片

**触发条件**：数据报总长度 > 链路层 MTU（以太网默认 1500 字节）

**分片规则**：
- 每个分片有独立首部
- 片偏移以 **8字节** 为单位（故除最后一片外，每片数据长度必须是8的倍数）
- 只有**目的主机**重组分片（路由器不重组）
- DF=1 时，若需分片则丢弃并向源发 ICMP 错误

**分片计算例题**：

```
原始数据报：总长4000字节，首部20字节，数据3980字节，MTU=1500字节

分片1：数据1480字节，偏移=0，MF=1
分片2：数据1480字节，偏移=1480/8=185，MF=1
分片3：数据1020字节，偏移=2960/8=370，MF=0
```

---

## 三、ARP / ICMP / DHCP

### ARP（见数据链路层详细说明）

- [[02-科目/专业课/知识点/技术/计算机网络/02-数据链路层|02-数据链路层]] 第六节有完整流程
- 关键：ARP 是网络层协议（IPv4环境下），但运行在数据链路层上方

### ICMP（Internet 控制报文协议）

**两类报文**：

| 类型 | 说明 | 典型用途 |
|------|------|----------|
| **差错报告报文** | 通知源主机发生错误，不触发差错报告 | 目的不可达、超时（TTL=0）、参数错误、重定向 |
| **询问报文** | 用于测试和查询 | 回送请求/应答（ping）、时间戳请求/应答 |

**ping 原理**：发送 ICMP 回送请求（Echo Request），目标回应回送应答（Echo Reply）

**traceroute/tracert 原理**：发送 TTL 从1开始递增的 UDP（Linux）或 ICMP（Windows）包，每个路由器 TTL 减1变0后返回 ICMP 超时报文，从而获得路径上各路由器的 IP

**ICMP 不会为以下情况产生差错报告**：
- ICMP 差错报文本身出错
- 分片数据报（只对第一个分片产生）
- 广播/组播地址的数据报
- 特殊地址（0.0.0.0/127.x.x.x）

### DHCP（动态主机配置协议）

**功能**：自动为主机分配 IP 地址、子网掩码、默认网关、DNS 服务器

**使用 UDP**：客户端端口 68，服务器端口 67

**四步交互（DORA）**：

```
1. Discover：客户端广播 DHCP Discover（src=0.0.0.0:68, dst=255.255.255.255:67）
2. Offer：服务器单播/广播 DHCP Offer（提供可用IP地址）
3. Request：客户端广播 DHCP Request（告知选择哪个服务器的地址）
4. Acknowledge：服务器发送 DHCP ACK（确认分配）
```

- 分配的 IP 有**租约时间**，客户端需在租约到期前续租
- DHCP 中继代理：允许跨路由器转发 DHCP 广播

---

## 四、路由算法（★★★）

### RIP（路由信息协议）

| 属性 | 值 |
|------|----|
| 类型 | **距离向量（Distance Vector）** |
| 度量 | 跳数（Hop Count） |
| 最大跳数 | **15跳**（16表示不可达） |
| 更新方式 | 每 **30秒**向邻居广播整张路由表 |
| 收敛速度 | **慢**（好消息传播快，坏消息慢——计数到无穷问题） |
| 适用范围 | 小型网络（AS内部，IGP） |
| 传输协议 | UDP 端口 520 |
| 版本 | RIPv1（有类）/ RIPv2（无类，支持CIDR） |

**计数到无穷问题**：链路故障后，路由器通过邻居的过时信息循环更新，跳数缓慢增到16

**解决方法**：水平分割（不把从某邻居学到的路由再发回给该邻居）

### OSPF（开放最短路径优先）

| 属性 | 值 |
|------|----|
| 类型 | **链路状态（Link State）** |
| 度量 | 带宽、延迟等（可配置，默认基于接口带宽） |
| 更新方式 | 全网**泛洪 LSA**（链路状态通告），触发式更新 |
| 算法 | **Dijkstra** 最短路径算法 |
| 收敛速度 | **快** |
| 适用范围 | 中大型网络（AS内部，IGP） |
| 传输协议 | 直接封装在 IP 中，协议号 89 |
| 特性 | 支持等价多路径（ECMP）、区域划分（骨干区域Area 0） |

### BGP（边界网关协议）

| 属性 | 值 |
|------|----|
| 类型 | **路径向量（Path Vector）** |
| 用途 | **AS间路由**（EGP，域间路由协议） |
| 传输协议 | TCP 端口 **179** |
| 特点 | 考虑策略、路径属性（AS-PATH/NEXT-HOP等），不只追求最短路 |
| 会话类型 | iBGP（AS内部）/ eBGP（AS之间） |

### 三协议对比表

| 对比项 | RIP | OSPF | BGP |
|--------|-----|------|-----|
| 类型 | 距离向量 | 链路状态 | 路径向量 |
| 度量 | 跳数（≤15） | 带宽/延迟等 | AS路径属性 |
| 收敛速度 | 慢 | 快 | 慢 |
| 适用范围 | 小型AS内 | 中大型AS内 | AS之间 |
| 传输层 | UDP 520 | IP (协议89) | TCP 179 |
| 算法 | Bellman-Ford | Dijkstra | — |

---

## 五、NAT（网络地址转换）

**问题背景**：IPv4地址空间有限，私网地址（如192.168.x.x）不能在公网路由

**基本 NAT**：将私网 IP 一对一映射到公网 IP

**NAPT（端口地址转换 / PAT）**：多个私网主机共用一个公网 IP，用端口号区分

```
内部主机 192.168.1.10:12345 访问外部服务器
NAT 转换后变为 公网IP:5001 → 外部服务器
NAT 表记录：{公网IP:5001 ↔ 192.168.1.10:12345}
外部服务器响应发回公网IP:5001，NAT再转回内部
```

**NAT 的问题**：
- 破坏端到端连接（外部主机无法主动连接内部主机）
- 违反 IP 分层原则（修改了传输层端口）
- P2P 应用需要 NAT 穿透技术

---

## 六、IPv6（了解）

| 特性 | 说明 |
|------|------|
| 地址长度 | **128位**，解决地址耗尽问题 |
| 表示方法 | 冒号十六进制，如 `2001:0db8::1`（连续0可用::缩写，只能用一次） |
| 首部 | 固定 **40字节**，无校验和（交给传输层处理） |
| 分片 | 源端负责分片，**中间路由器不分片**（通过路径MTU发现） |
| 地址类型 | 单播、任播（Anycast）、组播（无广播概念） |
| 自动配置 | 无状态地址自动配置（SLAAC），不需要 DHCP |
| 过渡技术 | 双栈、隧道（将IPv6封装在IPv4中）、NAT64 |

**IPv6 特殊地址**：
- `::1` — 回环地址（相当于 127.0.0.1）
- `fe80::/10` — 链路本地地址（不被路由）
- `ff00::/8` — 组播地址

---

## 七、高频错误（5条）

**错误1**：子网主机数忘记减2

- 错：/26 主机数 = 2^6 = 64
- 正：主机数 = 2^6 - 2 = 62（网络地址和广播地址不可分配）

**错误2**：IP 分片偏移单位搞错

- 错：片偏移以字节为单位
- 正：片偏移以 **8字节** 为单位，所以分片数据长度（除最后一片）必须是8的整数倍

**错误3**：认为路由器会重组 IP 分片

- 错：路由器负责重组分片，传给下一跳
- 正：只有**目的主机**才重组分片，路由器只转发分片，不重组

**错误4**：RIP 跳数 ≤ 16

- 错：RIP 最大跳数是16
- 正：RIP 最大有效跳数是 **15**，跳数为 **16** 表示**不可达**

**错误5**：OSPF 使用 UDP 传输

- 错：OSPF 使用 UDP
- 正：OSPF **直接封装在 IP 包中**，IP 协议号为 89，不使用 TCP 或 UDP

---

## 公式快查

$$\text{子网主机数} = 2^{\text{主机位数}} - 2$$

$$\text{子网数（借k位）} = 2^k$$

$$\text{片偏移} = \frac{\text{该片数据在原报文中的字节偏移量}}{8}$$

$$\text{CIDR块包含地址数} = 2^{32-\text{前缀长度}}$$

---

## 相关链接

- [[02-科目/专业课/知识点/技术/计算机网络/00-网络MOC|00-网络MOC]]
- [[02-科目/专业课/知识点/技术/计算机网络/02-数据链路层|02-数据链路层]]（ARP在链路层实现，需要IP触发）
- [[02-科目/专业课/知识点/技术/计算机网络/04-传输层|04-传输层]]（IP是TCP/UDP的承载协议）
