---
subject: 专业课843
chapter: 计算机网络
mastery: 0
next-review: 2026-03-05
status: 未开始
created: 2026-02-27
---

# 04 — 传输层

> 导航：[[02-科目/专业课/知识点/技术/计算机网络/00-网络MOC|网络MOC]] | 上：[[02-科目/专业课/知识点/技术/计算机网络/03-网络层|03-网络层]] | 下：[[02-科目/专业课/知识点/技术/计算机网络/05-应用层|05-应用层]]

---

## 一、传输层功能

| 功能 | 说明 |
|------|------|
| **端到端通信** | 网络层提供主机到主机（逻辑通信），传输层提供**进程到进程**（端到端）通信 |
| **复用与分用** | 多个进程共用网络层（复用），到达目标后分发给对应进程（分用）——靠端口号实现 |
| **差错检测** | UDP/TCP 都有校验和字段 |
| **可靠传输** | TCP 提供，UDP 不提供 |
| **流量控制** | TCP 提供（接收窗口 rwnd） |
| **拥塞控制** | TCP 提供（慢开始、拥塞避免、快重传、快恢复） |

### 端口号

- **范围**：0 ~ 65535（16位）
- **知名端口（Well-Known Ports）**：0 ~ 1023，由 IANA 分配给标准协议
- **注册端口**：1024 ~ 49151，应用程序注册使用
- **动态/私有端口**：49152 ~ 65535，客户端临时端口（短暂端口）

| 协议 | 端口 | 传输层 |
|------|------|--------|
| HTTP | 80 | TCP |
| HTTPS | 443 | TCP |
| FTP控制 | 21 | TCP |
| FTP数据 | 20 | TCP |
| SMTP | 25 | TCP |
| POP3 | 110 | TCP |
| IMAP | 143 | TCP |
| DNS | 53 | UDP（大包用TCP） |
| DHCP服务端 | 67 | UDP |
| DHCP客户端 | 68 | UDP |
| TFTP | 69 | UDP |

---

## 二、UDP（用户数据报协议）（★）

### 特性

| 特性 | 说明 |
|------|------|
| **无连接** | 发送前不建立连接，直接发送 |
| **不可靠** | 不保证交付，不重传，不排序 |
| **面向报文** | 发送方交一个报文，UDP 加首部后直接发送，不拆分不合并 |
| **无拥塞控制** | 发送速率不受网络拥塞影响（可能加剧拥塞） |
| **首部开销小** | 只有 **8字节** 固定首部 |
| **支持广播/组播** | TCP 不支持 |

### UDP 首部格式（8字节）

```
┌────────────────┬────────────────┐
│   源端口(16)   │  目的端口(16)  │
├────────────────┼────────────────┤
│   长度(16)     │  校验和(16)    │
└────────────────┴────────────────┘
```

- **长度**：UDP首部 + 数据，最小值为8（只有首部）
- **校验和**：可选，覆盖伪首部（含源IP、目的IP、协议、UDP长度）+ UDP首部 + 数据

### 适用场景

- **DNS**：查询-应答，单次交互，UDP足够
- **DHCP**：广播发现，必须用UDP
- **TFTP**：简单文件传输，小文件
- **视频流/语音（VoIP）**：实时性优先，可容忍少量丢包
- **SNMP**：网络管理，简单查询

---

## 三、TCP（传输控制协议）（★★★）

### 特性

| 特性 | 说明 |
|------|------|
| **面向连接** | 通信前需三次握手建立连接，结束后四次挥手释放 |
| **可靠传输** | 序号、确认、超时重传保证数据完整交付 |
| **字节流** | TCP 不关心报文边界，将数据视为字节流 |
| **全双工** | 双方可同时发送和接收 |
| **流量控制** | 接收窗口（rwnd）限制发送速率 |
| **拥塞控制** | 感知网络拥塞，调整发送速率 |
| **首部开销** | 最小 **20字节**（固定部分） |

### TCP 首部格式（最小20字节）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
├──────────────────────────────┬──────────────────────────────────┤
│         源端口(16)           │          目的端口(16)             │
├──────────────────────────────────────────────────────────────────┤
│                          序号 seq(32)                            │
├──────────────────────────────────────────────────────────────────┤
│                          确认号 ack(32)                          │
├──────┬───────┬─┬─┬─┬─┬─┬─┬──────────────────────────────────────┤
│数据偏│ 保留  │U│A│P│R│S│F│             窗口(16)                  │
│移(4) │ (6)   │R│C│S│S│Y│I│                                      │
│      │       │G│K│H│T│N│N│                                      │
├──────────────────────────────┬──────────────────────────────────┤
│           校验和(16)         │          紧急指针(16)             │
├──────────────────────────────────────────────────────────────────┤
│                        选项（可变）                              │
└──────────────────────────────────────────────────────────────────┘
```

**关键字段**：

| 字段 | 说明 |
|------|------|
| **序号 (seq)** | 本报文段数据第一个字节的序号 |
| **确认号 (ack)** | 期望收到对方下一个字节的序号（ack=n 表示 n-1 之前的字节全部正确收到） |
| **数据偏移** | TCP首部长度，以4字节为单位（最小5，即20字节；最大15，即60字节） |
| **SYN** | 建立连接请求 |
| **ACK** | 确认位（ack字段有效） |
| **FIN** | 释放连接请求 |
| **RST** | 重置连接（异常终止） |
| **PSH** | 立即推送（不等缓冲区满） |
| **URG** | 紧急数据 |
| **窗口** | 接收窗口大小，控制对方发送速率 |

---

## 四、TCP 三次握手（★★★）

### 详细流程

```
客户端                              服务端
   │                                  │
   │── SYN=1, seq=x ──────────────→   │  第1次：客户端发起连接请求
   │   [SYN_SENT状态]                 │  [LISTEN状态→SYN_RCVD状态]
   │                                  │
   │   ←── SYN=1, ACK=1, seq=y, ack=x+1 ──│  第2次：服务端确认并发起连接
   │   [ESTABLISHED状态]              │
   │                                  │
   │── ACK=1, seq=x+1, ack=y+1 ────→ │  第3次：客户端确认
   │                                  │  [ESTABLISHED状态]
```

**每次报文说明**：

| 握手次 | 发送方 | SYN | ACK | seq | ack | 说明 |
|--------|--------|-----|-----|-----|-----|------|
| 第1次 | 客户端 | 1 | 0 | x（随机） | — | 请求建立连接，消耗1个序号 |
| 第2次 | 服务端 | 1 | 1 | y（随机） | x+1 | 确认客户端请求，并请求建立反向连接 |
| 第3次 | 客户端 | 0 | 1 | x+1 | y+1 | 确认服务端请求，连接建立完成 |

### 为什么需要三次握手？

**防止历史失效连接请求导致错误**：

- 若只有两次握手，旧的过期SYN到达服务端，服务端直接进入 ESTABLISHED，客户端却不知道，导致服务端白白等待
- 三次握手中，客户端收到服务端的SYN+ACK后，若是对过期请求的回应，客户端会发RST拒绝，服务端收到RST后关闭连接

---

## 五、TCP 四次挥手（★★★）

### 详细流程

```
主动关闭方（A）                      被动关闭方（B）
   │                                  │
   │── FIN=1, seq=u ───────────────→  │  第1次：A 请求关闭（发完数据）
   │   [FIN_WAIT_1状态]               │  [CLOSE_WAIT状态]
   │                                  │
   │   ←── ACK=1, seq=v, ack=u+1 ──  │  第2次：B 确认（B可能还有数据要发）
   │   [FIN_WAIT_2状态]               │
   │                                  │  （B继续发剩余数据...）
   │                                  │
   │   ←── FIN=1, ACK=1, seq=w, ack=u+1 ──│  第3次：B 也请求关闭
   │   [TIME_WAIT状态]                │  [LAST_ACK状态]
   │                                  │
   │── ACK=1, seq=u+1, ack=w+1 ────→ │  第4次：A 确认
   │   等待 2MSL 后→CLOSED            │  [CLOSED状态]
```

### TIME_WAIT 状态（2MSL 等待）

**TIME_WAIT 存在原因**：

1. **保证最后一个 ACK 能到达服务端**：若最后的 ACK 丢失，服务端会重发 FIN，客户端需要能重新发送 ACK
2. **防止旧连接的数据影响新连接**：等待 2MSL 确保本次连接所有报文消失

**MSL（Maximum Segment Lifetime）**：报文在网络中存活的最大时间，通常 **2分钟**，故 TIME_WAIT = **4分钟**

---

## 六、可靠传输

### 序号与确认号

- TCP 将数据视为**字节流**，每个字节有序号
- **seq**：本段第一个字节的序号
- **ack**：期望收到的下一个字节序号（累积确认）
- SYN 和 FIN 各消耗一个序号，数据字节也消耗序号

### 累积确认

接收方不必每收一个报文就发一个 ACK，可以累积多个报文后发一个 ACK，或接收后延迟发送（最多延迟 500ms）

### 超时重传

- **RTO（重传超时时间）**：动态计算，基于 RTT 测量值
- $RTT_s = (1-\alpha) \times RTT_s + \alpha \times RTT_{new}$（α通常取0.125）
- $RTO = RTT_s + 4 \times RTT_d$（RTT_d 是RTT偏差）
- 超时后重传，RTO 翻倍（指数退避）

### 快速重传

- 收到 **3个重复 ACK**（即同一序号的第4个ACK）时，**不等超时**立即重传
- 说明该序号的报文大概率丢失（后续报文已到达但有缺口）

---

## 七、流量控制（★★）

### 接收窗口（rwnd）

接收方在 ACK 中告知发送方自己的缓冲区剩余空间（接收窗口大小），发送方不得发送超出 rwnd 的数据

```
发送方实际可发送量 = min(cwnd, rwnd)
```

### 窗口为0时的处理

- 接收方窗口变为0时，发送方停止发送
- **坚持定时器（Persist Timer）**：发送方定期发送 **窗口探测报文**（1字节），防止接收方窗口恢复通知丢失导致死锁

---

## 八、拥塞控制（★★★）

### 四种机制

**关键变量**：
- `cwnd`：拥塞窗口（发送方维护）
- `ssthresh`：慢开始阈值
- 发送量 = min(cwnd, rwnd)

### 慢开始（Slow Start）

- 初始 cwnd = 1 MSS（最大报文段）
- 每收到一个 ACK，cwnd += 1（每个 RTT 翻倍）
- 指数增长，直到 cwnd ≥ ssthresh

### 拥塞避免（Congestion Avoidance）

- cwnd ≥ ssthresh 时进入
- 每经过一个 RTT（收到整个窗口的 ACK），cwnd **+= 1**
- 线性增长（加法增大，AIMD 中的 AI 部分）

### 快重传（Fast Retransmit）

- 收到 3 个重复 ACK → 立即重传丢失报文（无需等超时）
- 不进入慢开始，而是进入**快恢复**

### 快恢复（Fast Recovery）

- 触发条件：快重传（3个重复ACK）
- 处理：
  - ssthresh = cwnd / 2
  - cwnd = ssthresh（而非从1开始）
  - 进入**拥塞避免**（线性增长）

### 超时处理（严重拥塞）

- ssthresh = cwnd / 2
- cwnd = 1（重新慢开始）
- 比快恢复更激进，用于超时（丢包更严重的信号）

### cwnd 变化曲线（文字描述）

```
cwnd
 │                    ×（超时，cwnd→1，ssthresh→一半）
 │         /        /
 │        /       /
ssthresh─┼──────/─
 │      /  ↗快恢复入拥塞避免
 │    /（慢开始指数上升）
 │   /
 1──┼──────────────────────────────→ 时间/RTT
    │←慢开始→│←拥塞避免(线性)→│
                              ↑3个重复ACK
                      ssthresh=cwnd/2，cwnd=ssthresh（快恢复）
```

### 拥塞控制 vs 流量控制

| 对比 | 拥塞控制 | 流量控制 |
|------|----------|----------|
| 目的 | 防止网络过载 | 防止接收方缓冲区溢出 |
| 控制量 | cwnd（拥塞窗口） | rwnd（接收窗口） |
| 信息来源 | 丢包/延迟（网络状态） | 接收方通告的窗口大小 |
| 作用范围 | 端到端 | 端到端 |
| 实际发送 | min(cwnd, rwnd) | min(cwnd, rwnd) |

---

## 九、高频错误（5条）

**错误1**：TCP 三次握手第3次 ACK 中 seq 填错

- 错：第3次 seq=x（初始seq）
- 正：第3次 seq=x+1（因为第1次SYN消耗了序号x，所以下一个序号是x+1）

**错误2**：四次挥手认为 TIME_WAIT 在服务端

- 错：TIME_WAIT 在服务端
- 正：TIME_WAIT 在**主动发起关闭**的一方（通常是客户端，但也可能是服务端）

**错误3**：快恢复后 cwnd 从 1 开始

- 错：快重传触发后 cwnd=1，重新慢开始
- 正：快重传后进入**快恢复**，cwnd = ssthresh = 原cwnd/2，然后进入**拥塞避免**（线性增长），不是慢开始

**错误4**：超时和3个重复ACK的处理相同

- 错：超时和3个重复ACK都进入快恢复
- 正：超时更严重（cwnd=1重新慢开始）；3个重复ACK进入快恢复（cwnd=ssthresh=原一半）

**错误5**：UDP 不做任何差错处理

- 错：UDP 完全不检测错误
- 正：UDP 有**校验和字段**用于检错，但检测到错误后直接**丢弃**，不重传

---

## 公式快查

$$\text{发送方可发送量} = \min(cwnd, rwnd)$$

$$\text{快重传触发条件} = \text{收到3个重复ACK（共4个相同ACK）}$$

$$\text{快恢复}: ssthresh = cwnd/2, \quad cwnd = ssthresh$$

$$\text{超时}: ssthresh = cwnd/2, \quad cwnd = 1 \text{ (MSS)}$$

$$RTO = RTT_s + 4 \times RTT_d$$

| 事件 | ssthresh | cwnd | 进入状态 |
|------|----------|------|----------|
| 超时 | cwnd/2 | 1 MSS | 慢开始 |
| 3个重复ACK | cwnd/2 | ssthresh | 拥塞避免 |
| 正常传输 (cwnd<ssthresh) | 不变 | 每RTT翻倍 | 慢开始 |
| 正常传输 (cwnd≥ssthresh) | 不变 | 每RTT+1 | 拥塞避免 |

---

## 相关链接

- [[02-科目/专业课/知识点/技术/计算机网络/00-网络MOC|00-网络MOC]]
- [[02-科目/专业课/知识点/技术/计算机网络/03-网络层|03-网络层]]（TCP/UDP 运行在 IP 之上）
- [[02-科目/专业课/知识点/技术/计算机网络/05-应用层|05-应用层]]（HTTP、DNS 等使用 TCP/UDP）
- [[02-科目/专业课/知识点/技术/计算机网络/02-数据链路层|02-数据链路层]]（滑动窗口思想同源）
