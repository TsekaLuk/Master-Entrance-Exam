---
subject: 专业课843
chapter: 计算机组成原理
mastery: 0
next-review: 2026-03-05
status: 未开始
created: 2026-02-27
---

# 总线与 IO

## 一、总线

### 总线分类（按功能）

| 类型 | 方向 | 传输内容 | 说明 |
|------|------|----------|------|
| **数据总线（DB）** | 双向 | 数据 | 宽度 = 机器字长（或半字长），决定一次传输的数据量 |
| **地址总线（AB）** | 单向（CPU→其他） | 地址 | 宽度决定寻址空间大小（$n$ 位 → $2^n$ 个地址） |
| **控制总线（CB）** | 双向 | 控制信号 | 读/写、中断请求/响应、总线请求/允许、复位等 |

### 总线层次（按位置）

| 层次 | 名称 | 说明 |
|------|------|------|
| 片内总线 | 芯片内部总线 | CPU 内部各部件连接（ALU、寄存器之间） |
| 系统总线 | 内部总线 | 连接 CPU、主存、IO接口（主板上的总线） |
| 通信总线 | 外部总线 | 连接计算机系统与外部设备（USB、PCIe等） |

系统总线又分：单总线结构（所有设备共享一条）、双总线结构、多总线结构（高性能）

### 总线仲裁（解决多设备同时申请总线的竞争）

#### 集中仲裁

| 方式 | 原理 | 优点 | 缺点 |
|------|------|------|------|
| **链式查询（菊花链）** | 仲裁线串行连接各设备，靠近控制器的优先级高 | 电路简单，扩展方便 | 对故障敏感，优先级固定且不灵活 |
| **计数器查询** | 控制器用计数器依次查询，计数器初值决定优先级 | 优先级可调（改初值） | 需要设备地址线，稍复杂 |
| **独立请求** | 每个设备有独立的请求线和允许线 | 响应速度快，优先级灵活 | 线路最多，控制器复杂 |

#### 分布仲裁

- 无中央仲裁器，各设备自行仲裁（如 SCI 总线）
- 竞争逻辑分布在各设备中

### 总线定时（同步与异步）

| 方式 | 原理 | 特点 |
|------|------|------|
| **同步定时** | 统一时钟控制，每次操作占固定时钟周期 | 简单，速度快，但必须迁就最慢设备 |
| **异步定时** | 握手信号（Request/Acknowledge）协调，无统一时钟 | 灵活，适应不同速度设备，但电路复杂 |
| **半同步定时** | 以同步为基础，允许插入等待周期 | 折中 |
| **分离事务总线** | 申请和数据传输分两次独立完成，提高总线利用率 | 高性能 |

### 总线带宽

$$\text{总线带宽} = \frac{\text{总线宽度（bit）} \times \text{工作频率（Hz）}}{8} \quad \text{(Byte/s)}$$

例：64位总线，100MHz：$64 \times 10^8 / 8 = 800 \text{ MB/s}$

---

## 二、IO 接口

### IO 接口的功能

1. **数据缓冲**：解决 CPU（快）与 IO 设备（慢）之间的速度差异
2. **状态标志**：提供设备忙/就绪/错误状态给 CPU 查询
3. **格式转换**：并行/串行转换，电平转换，编码转换
4. **地址译码**：识别 CPU 发来的设备选择信号
5. **中断管理**：产生中断请求，支持中断方式传输

### IO 端口（Port）

| 端口类型 | 内容 | 操作 |
|----------|------|------|
| **数据寄存器** | 传输的数据 | 读/写 |
| **状态寄存器** | 设备当前状态（忙/就绪/错误） | 只读 |
| **控制寄存器** | 发给设备的控制命令 | 只写 |

### IO 地址编址方式

| 方式 | 原理 | 优点 | 缺点 |
|------|------|------|------|
| **独立编址** | IO 端口地址空间独立，专用 IN/OUT 指令 | 地址空间不占用内存 | 需要专用指令 |
| **统一编址（存储器映射 IO）** | IO 端口占用内存地址空间 | 可用所有访存指令 | 减少了内存可用地址 |

---

## 三、IO 控制方式 ★★★

### 完整对比表

| 方式 | CPU 占用率 | 数据单位 | 中断 | 适用场景 | 优点 | 缺点 |
|------|------------|----------|------|----------|------|------|
| **程序查询（轮询）** | 100%（CPU 全程等待） | 字节/字 | 无 | 低速、简单设备 | 实现最简单 | CPU 利用率极低 |
| **中断驱动** | 低（仅处理中断时） | 字节/字 | 有 | 中速设备，键盘鼠标 | CPU 利用率提高 | 每个数据都中断，频繁切换开销大 |
| **DMA** | 极低（仅开始和结束） | 数据块 | 有（完成时）| 高速设备，磁盘、网卡 | 块传输，CPU 开销小 | 需要专用 DMA 控制器 |
| **通道** | 最低 | 程序控制的多块数据 | 有（完成时）| 大型机，高速批量 IO | 功能最强，CPU 几乎不参与 | 需要专用通道处理机 |

### 程序查询方式（轮询 Polling）

```
while (设备忙):        # CPU 不断读状态寄存器
    检查状态
数据 ← IO端口         # 才能读取数据
```

CPU 在等待期间无法做任何其他事，浪费大量时间。

### 中断驱动方式

1. CPU 启动 IO 操作后继续执行其他程序
2. IO 设备完成数据准备后，向 CPU 发出中断请求（INTR）
3. CPU 在指令执行结束后响应中断
4. CPU 进入中断服务程序，从 IO 接口取走数据
5. CPU 从中断返回，继续之前的程序

特点：每传输 1 字节/字就中断一次，频繁中断对 CPU 有一定开销。

### DMA（Direct Memory Access）方式

DMA 控制器（DMAC）直接控制总线，在主存和 IO 设备间传输数据，**不经过 CPU**。

**DMA 传输流程**：

```
1. CPU 初始化 DMA 控制器（设置源地址、目标地址、传输字节数）
2. CPU 启动 IO 操作，继续执行自己的程序
3. DMA 控制器向总线仲裁器发出总线请求（DREQ）
4. 总线裁决器允许 DMA 使用总线（DACK），CPU 放弃总线（挂起）
5. DMA 控制器直接在 IO 设备和主存之间传输一个数据块
6. 传输完成后，DMA 控制器向 CPU 发出中断请求（报告完成）
7. CPU 处理中断，检查结果
```

**DMA 与主存的传输时机**：
- **CPU 停止法**：DMA 用总线时 CPU 完全停止（实现简单，但 CPU 效率低）
- **周期挪用法（Cycle Stealing）**：DMA 每次只偷用 1 个内存周期，CPU 访存后再偷（效率高，最常用）
- **交替访问法**：适合快速设备，CPU 和 DMA 交替使用总线

### 通道方式

- 通道 = 专用 IO 处理器，有独立的通道程序（存在主存中）
- CPU 只需发出 IO 指令，通道自主完成整个 IO 过程
- 适合大型机，多路并发 IO

### 各方式的工作模式总结

```
轮询：  CPU ──→ 一直等 ──→ 数据就绪 ──→ 处理
中断：  CPU ──→ 做别的 ←─ IO中断 ──→ 处理
DMA：   CPU ──→ 做别的 ←─ DMA完成中断 ──→ 确认完成
通道：  CPU ──→ 做别的 ←─ 通道完成中断 ──→ 确认完成
```

---

## 四、高频错误 ❌

1. **DMA 不是完全不中断 CPU**：DMA 在开始时需要 CPU 初始化，结束时需要中断 CPU 报告完成，只是传输过程中不打扰 CPU
2. **中断驱动传输的单位是字节/字**，不是块；DMA 传输的单位是**数据块**，这是两者的本质区别
3. **地址总线是单向的**（CPU 发出地址），数据总线是**双向的**（读写均用），控制总线方向取决于具体信号（混合双向）；不要说"控制总线是单向的"
4. **链式查询仲裁中靠近控制器的设备优先级高**，不是"靠近 CPU 的"（链式查询是仲裁线从控制器出发依次连接各设备）

---

## 公式快查

$$\text{总线带宽（B/s）} = \frac{\text{总线宽度（bit）} \times f(\text{Hz})}{8}$$

$$\text{寻址空间} = 2^n \quad (n = \text{地址总线宽度})$$

$$\text{每秒最大传输次数（同步）} = \frac{f}{\text{每次传输占用周期数}}$$

---

## 相关链接

- [[00-组成原理MOC]]
- [[01-数据表示与运算]]
- [[02-存储器层次结构]]
- [[03-指令系统]]
- [[04-CPU与流水线]]
- [[错题汇总-计算机组成原理]]
